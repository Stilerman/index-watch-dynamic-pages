
{% extends "layout.html" %}

{% block title %}–ì—Ä—É–ø–ø—ã URL{% endblock %}

{% block content %}
<div class="groups-page">
    <div class="page-header">
        <h1>–ì—Ä—É–ø–ø—ã URL</h1>
        <div class="actions">
            <button id="add-group-btn" class="btn primary">
                <span class="icon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
            </button>
        </div>
    </div>

    {% if groups %}
    <div class="groups-grid">
        {% for group in groups %}
        <div class="card group-card" data-group-id="{{ group.id }}">
            <div class="card-header">
                <h3>{{ group.name }}</h3>
                <div class="actions">
                    <button class="btn icon-btn edit-group" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                    <button class="btn icon-btn delete-group" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
            </div>
            <div class="card-content">
                <div class="group-meta">
                    <span class="badge outline">{{ group.urls|length }} URL</span>
                    <button class="btn sm outline add-url-to-group">
                        <span class="icon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å URL
                    </button>
                </div>
                <div class="url-list">
                    {% if group.urls %}
                        <ul>
                            {% for url in group.urls[:5] %}
                            <li title="{{ url }}">{{ url }}</li>
                            {% endfor %}
                            {% if group.urls|length > 5 %}
                            <li class="more-urls">–∏ –µ—â–µ {{ group.urls|length - 5 }} URL...</li>
                            {% endif %}
                        </ul>
                    {% else %}
                        <p class="no-urls">–ù–µ—Ç URL –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state-container">
        <div class="empty-state-icon">üìÅ</div>
        <h2>–ù–µ—Ç –≥—Ä—É–ø–ø URL</h2>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞—à–∏—Ö URL.</p>
        <button id="add-group-empty-btn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>
    {% endif %}

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div id="edit-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="group-name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" id="group-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn outline" id="cancel-edit-group">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn primary" id="save-group">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div id="add-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-group-name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" id="new-group-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn outline" id="cancel-add-group">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn primary" id="create-group">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è URL –≤ –≥—Ä—É–ø–ø—É -->
    <div id="add-url-to-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å URL –≤ –≥—Ä—É–ø–ø—É</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="urls-for-group">URL –∞–¥—Ä–µ—Å–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                    <textarea id="urls-for-group" rows="5" placeholder="https://example.com/page1&#10;https://example.com/page2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn outline" id="cancel-add-url-to-group">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn primary" id="confirm-add-url-to-group">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
    function openModal(modal) {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }
    
    function closeModal(modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    const editGroupModal = document.getElementById('edit-group-modal');
    const groupNameInput = document.getElementById('group-name');
    let currentGroupId = null;
    
    document.querySelectorAll('.edit-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupCard = this.closest('.group-card');
            const groupId = groupCard.getAttribute('data-group-id');
            const groupName = groupCard.querySelector('.card-header h3').textContent;
            
            currentGroupId = groupId;
            groupNameInput.value = groupName;
            
            openModal(editGroupModal);
        });
    });
    
    document.querySelectorAll('.close-modal, #cancel-edit-group').forEach(element => {
        element.addEventListener('click', function() {
            closeModal(editGroupModal);
        });
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
    document.getElementById('save-group').addEventListener('click', function() {
        const newName = groupNameInput.value.trim();
        if (!newName || !currentGroupId) return;
        
        fetch('/api/update_group', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: currentGroupId,
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const groupCard = document.querySelector(`.group-card[data-group-id="${currentGroupId}"]`);
                if (groupCard) {
                    groupCard.querySelector('.card-header h3').textContent = newName;
                }
                
                closeModal(editGroupModal);
            } else {
                showToast('error', data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
            }
        })
        .catch(error => {
            showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã: ' + error.message);
        });
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    document.querySelectorAll('.delete-group').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É? URL –∏–∑ –≥—Ä—É–ø–ø—ã –Ω–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.')) {
                const groupCard = this.closest('.group-card');
                const groupId = groupCard.getAttribute('data-group-id');
                
                fetch('/api/delete_group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: groupId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                        groupCard.style.opacity = '0';
                        setTimeout(() => {
                            groupCard.remove();
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –µ—â–µ –≥—Ä—É–ø–ø—ã
                            if (document.querySelectorAll('.group-card').length === 0) {
                                window.location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                            }
                        }, 300);
                    } else {
                        showToast('error', data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                    }
                })
                .catch(error => {
                    showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã: ' + error.message);
                });
            }
        });
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
    const addGroupModal = document.getElementById('add-group-modal');
    const addGroupBtns = document.querySelectorAll('#add-group-btn, #add-group-empty-btn');
    
    addGroupBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            openModal(addGroupModal);
        });
    });
    
    document.querySelectorAll('.close-modal, #cancel-add-group').forEach(element => {
        element.addEventListener('click', function() {
            closeModal(addGroupModal);
        });
    });
    
    document.getElementById('create-group').addEventListener('click', function() {
        const newGroupName = document.getElementById('new-group-name').value.trim();
        if (!newGroupName) return;
        
        fetch('/api/add_group', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: newGroupName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
            }
        })
        .catch(error => {
            showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã: ' + error.message);
        })
        .finally(() => {
            closeModal(addGroupModal);
        });
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ URL –≤ –≥—Ä—É–ø–ø—É
    const addUrlToGroupModal = document.getElementById('add-url-to-group-modal');
    const urlsForGroupTextarea = document.getElementById('urls-for-group');
    
    document.querySelectorAll('.add-url-to-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupCard = this.closest('.group-card');
            currentGroupId = groupCard.getAttribute('data-group-id');
            urlsForGroupTextarea.value = '';
            
            openModal(addUrlToGroupModal);
        });
    });
    
    document.querySelectorAll('.close-modal, #cancel-add-url-to-group').forEach(element => {
        element.addEventListener('click', function() {
            closeModal(addUrlToGroupModal);
        });
    });
    
    document.getElementById('confirm-add-url-to-group').addEventListener('click', function() {
        const urls = urlsForGroupTextarea.value.split('\n').filter(url => url.trim() !== '');
        if (urls.length === 0 || !currentGroupId) return;
        
        fetch('/api/add_urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                urls: urls,
                groupIdOrName: currentGroupId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
            }
        })
        .catch(error => {
            showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ URL: ' + error.message);
        })
        .finally(() => {
            closeModal(addUrlToGroupModal);
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
});
</script>
{% endblock %}
