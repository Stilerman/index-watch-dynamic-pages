
{% extends "layout.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1>–î–∞—à–±–æ—Ä–¥</h1>
        <div class="actions">
            <button id="add-url-btn" class="btn primary">
                <span class="icon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å URL
            </button>
            <button id="refresh-all-btn" class="btn outline" {% if total_urls == 0 %}disabled{% endif %}>
                <span class="icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
            </button>
        </div>
    </div>

    <div class="stats-cards">
        <div class="card stat-card">
            <div class="card-header">
                <h3>–í—Å–µ–≥–æ URL</h3>
                <div class="icon blue">üîó</div>
            </div>
            <div class="card-content">
                <div class="stat-value">{{ total_urls }}</div>
            </div>
        </div>
        <div class="card stat-card">
            <div class="card-header">
                <h3>–ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ Google</h3>
                <div class="icon blue">G</div>
            </div>
            <div class="card-content">
                <div class="stat-value">{{ indexed_in_google }} –∏–∑ {{ total_urls }}</div>
                {% if total_urls > 0 %}
                <div class="stat-trend {% if indexed_in_google == total_urls %}positive{% else %}negative{% endif %}">
                    <span>{% if indexed_in_google == total_urls %}‚Üë{% else %}‚Üì{% endif %}</span>
                    <span>{{ (indexed_in_google / total_urls * 100) | round }}%</span>
                    <span class="trend-period">–∑–∞ 7 –¥–Ω–µ–π</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card stat-card">
            <div class="card-header">
                <h3>–ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –Ø–Ω–¥–µ–∫—Å</h3>
                <div class="icon blue">–Ø</div>
            </div>
            <div class="card-content">
                <div class="stat-value">{{ indexed_in_yandex }} –∏–∑ {{ total_urls }}</div>
                {% if total_urls > 0 %}
                <div class="stat-trend {% if indexed_in_yandex == total_urls %}positive{% else %}negative{% endif %}">
                    <span>{% if indexed_in_yandex == total_urls %}‚Üë{% else %}‚Üì{% endif %}</span>
                    <span>{{ (indexed_in_yandex / total_urls * 100) | round }}%</span>
                    <span class="trend-period">–∑–∞ 7 –¥–Ω–µ–π</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card stat-card {% if not_indexed_total > 0 %}border-red{% endif %}">
            <div class="card-header">
                <h3>–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</h3>
                <div class="icon blue">‚úì</div>
            </div>
            <div class="card-content">
                <div class="stat-value">{{ not_indexed_total }}</div>
            </div>
        </div>
    </div>

    <div class="url-table-container">
        <div class="table-filters">
            <div class="search-container">
                <input type="text" id="url-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ URL..." class="search-input">
            </div>
            <div class="group-filter">
                <select id="group-filter" class="select">
                    <option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="results-count">
                <span>–ü–æ–∫–∞–∑–∞–Ω–æ: <span id="filtered-count">{{ results|length }}</span> –∏–∑ {{ results|length }}</span>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="data-table" id="urls-table">
                <thead>
                    <tr>
                        <th>URL</th>
                        <th>–ì—Ä—É–ø–ø–∞</th>
                        <th>Google</th>
                        <th>–Ø–Ω–¥–µ–∫—Å</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% if results %}
                        {% for item in results %}
                        <tr data-url="{{ item.url }}">
                            <td class="url-cell">
                                <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer">{{ item.url }}</a>
                            </td>
                            <td>
                                {% for group in groups %}
                                    {% if item.url in group.urls %}
                                        {{ group.name }}
                                        {% break %}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</span>
                                {% endfor %}
                            </td>
                            <td>
                                <span class="badge {% if item.google %}success{% else %}error{% endif %}">
                                    {% if item.google %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if item.yandex %}success{% else %}error{% endif %}">
                                    {% if item.yandex %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                                </span>
                            </td>
                            <td>{{ item.date | truncate(16, True, '', 0) }}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn icon-btn dropdown-toggle">‚ãÆ</button>
                                    <div class="dropdown-menu">
                                        <a href="#" class="check-url" data-url="{{ item.url }}">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å</a>
                                        <a href="#" class="delete-url" data-url="{{ item.url }}">–£–¥–∞–ª–∏—Ç—å</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="empty-state">
                                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ URL –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è URL -->
    <div id="add-url-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="urls">URL –∞–¥—Ä–µ—Å–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                    <textarea id="urls" rows="5" placeholder="https://example.com/page1&#10;https://example.com/page2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</label>
                    <div class="group-selection">
                        <select id="group-select" class="select" disabled>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <button id="toggle-group-type" class="btn outline">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</button>
                    </div>
                </div>
                
                <div class="form-group" id="new-group-container" style="display:none;">
                    <label for="new-group">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" id="new-group" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–ª–æ–≥">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn outline" id="cancel-add-url">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn primary" id="confirm-add-url">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
    function openModal(modal) {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }
    
    function closeModal(modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è URL
    const addUrlModal = document.getElementById('add-url-modal');
    const addUrlBtn = document.getElementById('add-url-btn');
    
    addUrlBtn.addEventListener('click', function() {
        openModal(addUrlModal);
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.querySelectorAll('.close-modal, #cancel-add-url').forEach(element => {
        element.addEventListener('click', function() {
            closeModal(addUrlModal);
        });
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤—ã–±–æ—Ä–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
    const toggleGroupBtn = document.getElementById('toggle-group-type');
    const groupSelect = document.getElementById('group-select');
    const newGroupContainer = document.getElementById('new-group-container');
    const newGroupInput = document.getElementById('new-group');
    let isNewGroup = false;
    
    toggleGroupBtn.addEventListener('click', function() {
        isNewGroup = !isNewGroup;
        if (isNewGroup) {
            toggleGroupBtn.textContent = '–í—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é';
            groupSelect.disabled = true;
            newGroupContainer.style.display = 'block';
        } else {
            toggleGroupBtn.textContent = '–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞';
            groupSelect.disabled = false;
            newGroupContainer.style.display = 'none';
        }
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ URL
    const confirmAddUrlBtn = document.getElementById('confirm-add-url');
    const urlsTextarea = document.getElementById('urls');
    
    confirmAddUrlBtn.addEventListener('click', function() {
        const urls = urlsTextarea.value.split('\n').filter(url => url.trim() !== '');
        if (urls.length === 0) return;
        
        let groupIdOrName = null;
        if (isNewGroup && newGroupInput.value.trim()) {
            groupIdOrName = newGroupInput.value.trim();
        } else if (!isNewGroup && groupSelect.value) {
            groupIdOrName = groupSelect.value;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/api/add_urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                urls: urls,
                groupIdOrName: groupIdOrName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
            }
        })
        .catch(error => {
            showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ URL: ' + error.message);
        })
        .finally(() => {
            closeModal(addUrlModal);
        });
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL
    document.querySelectorAll('.check-url').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.getAttribute('data-url');
            
            fetch('/api/check_url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('error', data.message);
                }
            })
            .catch(error => {
                showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ URL: ' + error.message);
            });
        });
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ URL
    document.querySelectorAll('.delete-url').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç URL?')) {
                const url = this.getAttribute('data-url');
                
                fetch('/api/delete_url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                        const row = this.closest('tr');
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            updateFilteredCount();
                        }, 300);
                    } else {
                        showToast('error', data.message);
                    }
                })
                .catch(error => {
                    showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ URL: ' + error.message);
                });
            }
        });
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö URL
    const refreshAllBtn = document.getElementById('refresh-all-btn');
    
    refreshAllBtn.addEventListener('click', function() {
        if (this.disabled) return;
        
        this.disabled = true;
        this.innerHTML = '<span class="icon">üîÑ</span> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        
        fetch('/api/refresh_all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<span class="icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ';
        });
    });
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
    const urlSearch = document.getElementById('url-search');
    const groupFilter = document.getElementById('group-filter');
    const urlsTable = document.getElementById('urls-table');
    const tableRows = urlsTable.querySelectorAll('tbody tr');
    const filteredCount = document.getElementById('filtered-count');
    
    function filterTable() {
        const searchTerm = urlSearch.value.toLowerCase();
        const selectedGroup = groupFilter.value;
        let count = 0;
        
        tableRows.forEach(row => {
            if (row.querySelector('.empty-state')) return;
            
            const url = row.querySelector('.url-cell a').textContent.toLowerCase();
            const matchesSearch = url.includes(searchTerm);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ
            let matchesGroup = true;
            if (selectedGroup) {
                const rowUrl = row.getAttribute('data-url');
                {% for group in groups %}
                if ('{{ group.id }}' === selectedGroup) {
                    matchesGroup = [{% for url in group.urls %}'{{ url }}'{% if not loop.last %},{% endif %}{% endfor %}].includes(rowUrl);
                }
                {% endfor %}
            }
            
            if (matchesSearch && matchesGroup) {
                row.style.display = '';
                count++;
            } else {
                row.style.display = 'none';
            }
        });
        
        filteredCount.textContent = count;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const tbody = urlsTable.querySelector('tbody');
        let emptyRow = tbody.querySelector('.empty-filter-row');
        
        if (count === 0 && tableRows.length > 0 && !tableRows[0].querySelector('.empty-state')) {
            if (!emptyRow) {
                emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-filter-row';
                emptyRow.innerHTML = `
                    <td colspan="6" class="empty-state">
                        <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.</p>
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
            emptyRow.style.display = '';
        } else if (emptyRow) {
            emptyRow.style.display = 'none';
        }
    }
    
    urlSearch.addEventListener('input', filterTable);
    groupFilter.addEventListener('change', filterTable);
    
    function updateFilteredCount() {
        const visibleRows = document.querySelectorAll('#urls-table tbody tr:not([style*="display: none"])');
        filteredCount.textContent = visibleRows.length;
    }
    
    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö –º–µ–Ω—é
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.nextElementSibling.classList.toggle('active');
        });
    });
    
    document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-menu.active').forEach(menu => {
            menu.classList.remove('active');
        });
    });
});
</script>
{% endblock %}
